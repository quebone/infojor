<?php
namespace Infojor\Presentation\Model;

require_once 'presentation/model/MainViewModel.php';
//require_once 'presentation/model/UserViewModel.php';
//require_once 'presentation/model/SchoolViewModel.php';

final class HeaderViewModel extends MainViewModel {
	
	private $logged;
	private $teacher;
	private $course;
	private $trimestre;
	private $classroom;
	private $user;
	private $school;
	private $userViewModel;
	private $schoolViewModel;
	
	public function __construct($model = null, $entityManager = null) {
		parent::__construct($model, $entityManager);
		$this->userViewModel = new UserViewModel(null, $entityManager);
		$this->schoolViewModel = new SchoolViewModel(null, $entityManager);
		$this->logged = false;
		$this->teacher = null;
		$this->course = null;
		$this->trimestre = null;
		$this->classroom = null;
		$this->setVars();
	}
	
	public function output()
	{
		$data = new \stdClass;
		if ($this->logged)
		{
			$data->user = $this->teacher->getName() . " " . $this->teacher->getSurnames();
			$data->school = "Curs: " . $this->course->getYear();
			if ($this->classroom != null) $data->school .= "| Aula: " . $this->classroom->getName();
			$data->school .= " | Trimestre: " . $this->trimestre->getNumber();
		}
		return $data;
	}
	
	private function getSessionVar($sessionVar)
	{
		if (isset($_SESSION[$sessionVar])) return $_SESSION[$sessionVar];
		return false;
	}

	private function setVars()
	{
//		session_start();
		$teacherId = $this->getSessionVar('userid');
		$this->logged = $teacherId != false;
		if ($teacherId) $this->teacher = $this->userViewModel->getTeacher($teacherId);
		$classroomId = $this->getSessionVar('classroom');
		if ($classroomId) $this->classroom = $this->schoolViewModel->getTeacher($classroomId);
		$this->course = $this->schoolViewModel->getActiveCourse();
		$this->trimestre = $this->schoolViewModel->getActiveTrimestre();
	}
}